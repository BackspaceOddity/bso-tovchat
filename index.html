<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'SouvenirGothic';
      src: url('SouvenirGothic Bold.otf') format('opentype');
      font-weight: bold;
      font-style: normal;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      background-color: #F5F2E9;
      overflow: hidden;
      width: 100%;
      height: 100%;
      font-family: 'EB Garamond', serif;
      color: #1A1A1A;
    }

    /* ---- Splash ---- */

    #splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: #F5F2E9;
      z-index: 10;
      overflow: hidden;
    }

    #splash svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
    }

    /* ---- Chat ---- */

    #chat {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow-y: auto;
      opacity: 0;
      transition: opacity 0.5s ease;
    }

    #chat.fade-in {
      opacity: 1;
    }

    #messages {
      padding: 16px 24px 24px;
    }

    #messages-inner {
      max-width: 720px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
    }

    .message {
      font-size: 18px;
      line-height: 1.6;
      margin-bottom: 24px;
      white-space: pre-wrap;
      word-wrap: break-word;
      width: 100%;
      padding: 16px 60px 16px 20px;
      border-radius: 12px;
      color: #FFFFFF;
      background: linear-gradient(135deg, #E8A04C, #D4A0E0, #E0E848);
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
      position: relative;
      overflow: hidden;
    }

    /* Grain overlay via pseudo-element */
    .message::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 12px;
      opacity: 0.4;
      mix-blend-mode: overlay;
      pointer-events: none;
      filter: url(#noise);
      background: transparent;
    }

    .message:last-child {
      margin-bottom: 8px;
    }

    .msg-copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 2;
      background: rgba(255, 255, 255, 0.15);
      border: none;
      border-radius: 6px;
      padding: 5px;
      cursor: pointer;
      transition: background 0.15s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 30px;
      height: 30px;
    }

    .msg-copy-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .msg-copy-btn svg {
      width: 18px;
      height: 18px;
    }

    /* ---- Control Panel (unified card) ---- */

    #control-panel {
      position: relative;
      z-index: 1;
      flex-shrink: 0;
      padding: 16px 24px 24px;
      margin-top: auto;
      transition: margin-top 0.4s ease;
    }

    #chat.has-response #control-panel {
      margin-top: 0;
      padding-top: 24px;
    }

    #control-card {
      max-width: 720px;
      margin: 0 auto;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
      display: grid;
      grid-template-columns: 65% 35%;
      grid-template-rows: 1fr auto;
      background: linear-gradient(135deg, #E8A04C, #D4A0E0, #E0E848);
      position: relative;
    }

    #control-card::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 12px;
      opacity: 0.4;
      mix-blend-mode: overlay;
      pointer-events: none;
      filter: url(#noise);
      background: transparent;
    }

    .cp-label {
      font-family: 'SouvenirGothic', 'EB Garamond', serif;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #FFFFFF;
      margin-bottom: 6px;
    }

    /* Left: DATA textarea */
    .card-data {
      grid-row: 1;
      grid-column: 1;
      display: flex;
      flex-direction: column;
      padding: 14px 16px;
    }

    #data-input {
      flex: 1;
      font-family: 'EB Garamond', serif;
      font-size: 16px;
      line-height: 1.5;
      color: #FFFFFF;
      background: transparent;
      border: none;
      padding: 0;
      resize: none;
      outline: none;
      min-height: 100px;
      position: relative;
      z-index: 1;
    }

    #data-input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    /* Right: dropdowns */
    .card-selectors {
      grid-row: 1;
      grid-column: 2;
      display: flex;
      flex-direction: column;
      border-left: 1px solid rgba(255, 255, 255, 0.25);
    }

    .card-select-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 14px 16px;
    }

    .cp-dropdown {
      position: relative;
    }

    .card-select-group + .card-select-group {
      border-top: 1px solid rgba(255, 255, 255, 0.25);
    }

    /* Custom dropdown trigger */
    .cp-dropdown-trigger {
      font-family: 'EB Garamond', serif;
      font-size: 16px;
      color: #FFFFFF;
      background: transparent;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 0;
      position: relative;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      text-align: left;
      width: 100%;
    }

    .cp-dropdown-trigger .dd-chevron {
      flex-shrink: 0;
      transition: transform 0.2s ease;
    }

    .cp-dropdown.open .cp-dropdown-trigger .dd-chevron {
      transform: rotate(-90deg);
    }

    .cp-dropdown-trigger .dd-text {
      opacity: 0.7;
    }

    .cp-dropdown-trigger .dd-text.has-value {
      opacity: 1;
    }

    /* Dropdown panel — positioned via JS */
    .cp-dropdown-panel {
      display: none;
      position: fixed;
      min-width: 200px;
      z-index: 100;
      background: linear-gradient(135deg, #D4A0E0, #C8A8D8, #E0E848);
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      max-height: 50vh;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.35) transparent;
    }

    .cp-dropdown-panel::-webkit-scrollbar {
      width: 6px;
    }

    .cp-dropdown-panel::-webkit-scrollbar-track {
      background: transparent;
    }

    .cp-dropdown-panel::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }

    .cp-dropdown-panel::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .cp-dropdown.open .cp-dropdown-panel {
      display: block;
    }

    .cp-dropdown-option {
      font-family: 'EB Garamond', serif;
      font-size: 16px;
      color: #FFFFFF;
      padding: 10px 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background 0.15s ease;
    }

    .cp-dropdown-option:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .cp-dropdown-option.selected {
      background: rgba(255, 255, 255, 0.1);
    }

    .cp-dropdown-option .dd-check {
      opacity: 0;
      font-size: 14px;
    }

    .cp-dropdown-option.selected .dd-check {
      opacity: 1;
    }

    /* Bottom: generate button */
    #generate-btn {
      grid-row: 2;
      grid-column: 1 / -1;
      font-family: 'SouvenirGothic', 'EB Garamond', serif;
      font-size: 18px;
      font-weight: bold;
      color: #FFFFFF;
      background: transparent;
      border: none;
      border-top: 1px solid rgba(255, 255, 255, 0.25);
      border-radius: 0;
      padding: 14px 24px;
      cursor: pointer;
      width: 100%;
      position: relative;
      z-index: 1;
      transition: opacity 0.2s ease;
    }

    #generate-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    #generate-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }


    /* ---- Thinking dots ---- */

    .thinking-dots {
      display: flex;
      gap: 6px;
      align-items: center;
      height: 27px;
    }

    .thinking-dots span {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.7);
      animation: dotPulse 1.2s ease-in-out infinite;
    }

    .thinking-dots span:nth-child(2) {
      animation-delay: 0.15s;
    }

    .thinking-dots span:nth-child(3) {
      animation-delay: 0.3s;
    }

    @keyframes dotPulse {
      0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
      30% { opacity: 1; transform: scale(1); }
    }

    /* ---- Password gate ---- */

    #password-gate {
      position: fixed;
      inset: 0;
      background-color: transparent;
      z-index: 20;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.4s ease;
    }

    #password-gate.hidden {
      opacity: 0;
      pointer-events: none;
    }

    #pw-box {
      text-align: center;
    }

    #pw-input-wrap {
      display: flex;
      align-items: center;
      background-image: linear-gradient(
        135deg,
        #E8A04C 0%,
        #E0985A 20%,
        #D4A0E0 45%,
        #C8B8E0 60%,
        #D0D848 80%,
        #E0E848 100%
      );
      background-size: 400% 400%;
      background-position: 30% 50%;
      border-radius: 12px;
      padding: 10px 16px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.10);
      position: relative;
      overflow: hidden;
      width: 320px;
    }

    #pw-input-wrap::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 12px;
      opacity: 0.4;
      mix-blend-mode: overlay;
      pointer-events: none;
      filter: url(#noise);
      background: transparent;
    }

    #pw-input {
      flex: 1;
      font-family: 'EB Garamond', serif;
      font-size: 18px;
      line-height: 1.5;
      color: #FFFFFF;
      background: transparent;
      border: none;
      outline: none;
      position: relative;
      z-index: 1;
    }

    #pw-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    #pw-error {
      font-family: 'EB Garamond', serif;
      font-size: 14px;
      color: #D06CD0;
      margin-top: 12px;
      height: 20px;
    }
  </style>
</head>
<body>
  <!-- SVG noise filter for grain texture -->
  <svg style="position:absolute;width:0;height:0;" aria-hidden="true">
    <filter id="noise">
      <feTurbulence type="fractalNoise" baseFrequency="0.65" numOctaves="3" stitchTiles="stitch"/>
      <feColorMatrix type="saturate" values="0"/>
    </filter>
  </svg>

  <!-- Password gate -->
  <div id="password-gate">
    <div id="pw-box">
      <div id="pw-input-wrap">
        <input type="password" id="pw-input" placeholder="Password..." autocomplete="off">
      </div>
      <div id="pw-error"></div>
    </div>
  </div>

  <!-- Splash -->
  <div id="splash" style="display:none;">
    <svg id="logo-svg" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
      <path class="logo-el" d="M267.18 133.339C267.18 157.332 260.58 176.783 256.42 176.783C252.26 176.783 252.116 157.332 252.116 133.339C252.116 109.345 252.26 89.8948 256.42 89.8948C260.58 89.8948 267.18 109.345 267.18 133.339Z" fill="black"/>
      <path class="logo-el" d="M233.305 134.008C233.305 183.194 228.15 223.068 225.773 223.068C223.396 223.068 224.697 183.194 224.697 134.008C224.697 84.8212 223.396 44.9476 225.773 44.9476C228.15 44.9476 233.305 84.8212 233.305 134.008Z" fill="black"/>
      <path class="logo-el" d="M201.543 133.5C201.543 197.683 197.464 249.713 195.087 249.713C192.71 249.713 192.935 197.683 192.935 133.5C192.935 69.3177 192.71 17.2875 195.087 17.2875C197.464 17.2875 201.543 69.3177 201.543 133.5Z" fill="black"/>
      <ellipse class="logo-el" cx="159.024" cy="133.59" rx="11.8362" ry="133.59" fill="black"/>
      <path class="logo-el" d="M128.375 133.313C128.375 204.393 125.569 262.015 116.06 262.015C106.552 262.015 93.9422 204.393 93.9422 133.313C93.9422 62.2321 106.552 4.60986 116.06 4.60986C125.569 4.60986 128.375 62.2321 128.375 133.313Z" fill="black"/>
      <path class="logo-el" d="M75.3212 133.754C75.3212 190.438 70.2526 236.39 49.1561 236.39C28.0596 236.39 0 190.438 0 133.754C0 77.0693 28.0596 31.1174 49.1561 31.1174C70.2526 31.1174 75.3212 77.0693 75.3212 133.754Z" fill="black"/>
    </svg>
  </div>

  <!-- Chat -->
  <div id="chat">
    <!-- Control panel -->
    <div id="control-panel">
      <div id="control-card">
        <div class="card-data">
          <div class="cp-label">Data</div>
          <textarea id="data-input" placeholder="Paste structured, high-quality source content here"></textarea>
        </div>
        <div class="card-selectors">
          <div class="card-select-group">
            <div class="cp-label">Rewrite</div>
            <div class="cp-dropdown" id="dd-rewrite">
              <button type="button" class="cp-dropdown-trigger">
                <span class="dd-text">Choose format...</span>
                <svg class="dd-chevron" width="10" height="6" viewBox="0 0 10 6" fill="none"><path d="M1 1l4 4 4-4" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
              <div class="cp-dropdown-panel">
                <div class="cp-dropdown-option" data-value="landing_page">Landing page<span class="dd-check">&#10003;</span></div>
                <div class="cp-dropdown-option" data-value="social_post">Social post<span class="dd-check">&#10003;</span></div>
                <div class="cp-dropdown-option" data-value="blog_post">Blog post<span class="dd-check">&#10003;</span></div>
                <div class="cp-dropdown-option" data-value="presentation_slides">Presentation slides<span class="dd-check">&#10003;</span></div>
                <div class="cp-dropdown-option" data-value="email_campaign">Email campaign<span class="dd-check">&#10003;</span></div>
                <div class="cp-dropdown-option" data-value="job_posting">Job posting<span class="dd-check">&#10003;</span></div>
                <div class="cp-dropdown-option" data-value="press_release">Press release<span class="dd-check">&#10003;</span></div>
                <div class="cp-dropdown-option" data-value="ad_copy">Ad copy<span class="dd-check">&#10003;</span></div>
                <div class="cp-dropdown-option" data-value="video_script">Video script<span class="dd-check">&#10003;</span></div>
                <div class="cp-dropdown-option" data-value="changelog">Changelog<span class="dd-check">&#10003;</span></div>
              </div>
            </div>
          </div>
          <div class="card-select-group">
            <div class="cp-label">Output</div>
            <div class="cp-dropdown" id="dd-output">
              <button type="button" class="cp-dropdown-trigger">
                <span class="dd-text">Choose output...</span>
                <svg class="dd-chevron" width="10" height="6" viewBox="0 0 10 6" fill="none"><path d="M1 1l4 4 4-4" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
              <div class="cp-dropdown-panel">
                <div class="cp-dropdown-option" data-value="plain_text">Plain text<span class="dd-check">&#10003;</span></div>
                <div class="cp-dropdown-option" data-value="claude_code_prompt">Claude Code prompt<span class="dd-check">&#10003;</span></div>
                <div class="cp-dropdown-option" data-value="markdown">Markdown<span class="dd-check">&#10003;</span></div>
              </div>
            </div>
          </div>
        </div>
        <button id="generate-btn">Generate</button>
      </div>
    </div>
    <!-- Messages (results area) -->
    <div id="messages" style="display:none;">
      <div id="messages-inner"></div>
    </div>
  </div>

  <script>
    /* ---- Password gate ---- */
    (function () {
      var gate = document.getElementById('password-gate');
      var pwInput = document.getElementById('pw-input');
      var pwError = document.getElementById('pw-error');
      var splash = document.getElementById('splash');
      var PASSWORD = 'tov';

      function unlock() {
        sessionStorage.setItem('tov-auth', '1');
        gate.classList.add('hidden');
        setTimeout(function () {
          gate.style.display = 'none';
          startSplash();
        }, 400);
      }

      // Check sessionStorage
      if (sessionStorage.getItem('tov-auth') === '1') {
        gate.style.display = 'none';
        startSplash();
      } else {
        pwInput.focus();
        pwInput.addEventListener('keydown', function (e) {
          if (e.key === 'Enter') {
            if (pwInput.value === PASSWORD) {
              unlock();
            } else {
              pwError.textContent = 'Incorrect password';
              pwInput.value = '';
            }
          }
        });
      }

      function startSplash() {
        splash.style.display = '';

        var SVG_W = 268, SVG_H = 268;
        var SVG_CX = SVG_W / 2, SVG_CY = SVG_H / 2;
        var vw = window.innerWidth, vh = window.innerHeight;
        var INITIAL_LOGO_PX = 140;

        var vbW0 = SVG_W * vw / INITIAL_LOGO_PX;
        var vbH0 = SVG_W * vh / INITIAL_LOGO_PX;
        var vbX0 = SVG_CX - vbW0 / 2;
        var vbY0 = SVG_CY - vbH0 / 2;

        var svg = document.getElementById('logo-svg');
        svg.setAttribute('viewBox', vbX0 + ' ' + vbY0 + ' ' + vbW0 + ' ' + vbH0);

        var shapeCenters = [259.6, 229.0, 197.2, 159.0, 111.2, 37.7];
        var elements = document.querySelectorAll('.logo-el');
        var elData = [];
        elements.forEach(function (el, i) {
          elData.push({ el: el, offsetX: shapeCenters[i] - SVG_CX });
        });

        var PAUSE = 500, ANIM_DURATION = 2500, FADE_START = 0.8;
        var ZOOM_FACTOR = 25, SPREAD_MULTIPLIER = 40;
        var chat = document.getElementById('chat');

        function easeIn(t) { return t * t * t; }

        var startTime = null;
        function animate(timestamp) {
          if (!startTime) startTime = timestamp;
          var t = Math.min((timestamp - startTime) / ANIM_DURATION, 1);

          if (t >= 1) {
            splash.style.display = 'none';
            chat.classList.add('fade-in');
            document.getElementById('data-input').focus();
            return;
          }

          var eased = easeIn(t);
          var zoomScale = 1 + eased * (ZOOM_FACTOR - 1);
          var currentW = vbW0 / zoomScale;
          var currentH = vbH0 / zoomScale;
          svg.setAttribute('viewBox',
            (SVG_CX - currentW / 2) + ' ' + (SVG_CY - currentH / 2) + ' ' + currentW + ' ' + currentH);

          var opacity = t > FADE_START ? 1 - (t - FADE_START) / (1 - FADE_START) : 1;
          elData.forEach(function (d) {
            d.el.style.transform = 'translate(' + (d.offsetX * eased * SPREAD_MULTIPLIER) + 'px, 0)';
            d.el.style.opacity = opacity;
          });

          requestAnimationFrame(animate);
        }

        setTimeout(function () { requestAnimationFrame(animate); }, PAUSE);
      }
    })();

    /* ---- Chat logic ---- */
    (function () {
      var messagesInner = document.getElementById('messages-inner');
      var messagesArea = document.getElementById('messages');
      var generateBtn = document.getElementById('generate-btn');
      var dataInput = document.getElementById('data-input');
      var chatEl = document.getElementById('chat');

      // Custom dropdown state
      var ddState = { rewrite: '', output: '' };
      var ddDefaults = { rewrite: 'Choose format...', output: 'Choose output...' };

      document.querySelectorAll('.cp-dropdown').forEach(function (dd) {
        var id = dd.id.replace('dd-', '');
        var trigger = dd.querySelector('.cp-dropdown-trigger');
        var panel = dd.querySelector('.cp-dropdown-panel');
        var textEl = trigger.querySelector('.dd-text');
        trigger.addEventListener('click', function (e) {
          e.stopPropagation();
          var wasOpen = dd.classList.contains('open');
          document.querySelectorAll('.cp-dropdown.open').forEach(function (d) { d.classList.remove('open'); });
          if (!wasOpen) {
            dd.classList.add('open');
            // Position the panel to the right of the card, bottom-aligned with card bottom
            var cardRect = document.getElementById('control-card').getBoundingClientRect();
            var vh = window.innerHeight;
            var panelLeft = cardRect.right + 6;
            // If panel would overflow right edge, position to the left of the card
            if (panelLeft + 220 > window.innerWidth) {
              panelLeft = cardRect.left - 220 - 6;
              if (panelLeft < 0) panelLeft = 8;
            }
            panel.style.left = panelLeft + 'px';
            // Anchor bottom edge to card's bottom edge
            var bottomVal = vh - cardRect.bottom;
            if (bottomVal < 0) bottomVal = 8;
            panel.style.bottom = bottomVal + 'px';
            panel.style.top = 'auto';
          }
        });

        dd.querySelectorAll('.cp-dropdown-option').forEach(function (opt) {
          opt.addEventListener('click', function (e) {
            e.stopPropagation();
            var val = opt.getAttribute('data-value');
            dd.querySelectorAll('.cp-dropdown-option').forEach(function (o) { o.classList.remove('selected'); });
            opt.classList.add('selected');
            ddState[id] = val;
            textEl.textContent = opt.textContent.replace('✓', '').trim();
            textEl.classList.add('has-value');
            dd.classList.remove('open');
          });
        });
      });

      // Close dropdowns on outside click
      document.addEventListener('click', function () {
        document.querySelectorAll('.cp-dropdown.open').forEach(function (d) { d.classList.remove('open'); });
      });

      var messageCount = 0;
      function addMessage(text, role) {
        var div = document.createElement('div');
        div.className = 'message message-' + role;
        div.textContent = text;

        var posX = (messageCount * 27 + (role === 'user' ? 15 : 65)) % 100;
        var posY = (messageCount * 41 + (role === 'user' ? 25 : 70)) % 100;
        div.style.backgroundPosition = posX + '% ' + posY + '%';
        messageCount++;

        messagesInner.appendChild(div);
        messagesArea.scrollTop = messagesArea.scrollHeight;
        return div;
      }

      function addThinking() {
        var div = document.createElement('div');
        div.className = 'message message-ai';

        var posX = (messageCount * 27 + 65) % 100;
        var posY = (messageCount * 41 + 70) % 100;
        div.style.backgroundPosition = posX + '% ' + posY + '%';

        var clipboardSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
        var checkSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
        var copyBtn = document.createElement('button');
        copyBtn.className = 'msg-copy-btn';
        copyBtn.innerHTML = clipboardSvg;
        copyBtn.style.display = 'none';
        copyBtn.addEventListener('click', function () {
          var text = div.querySelector('.msg-text');
          navigator.clipboard.writeText(text ? text.textContent : div.textContent).then(function () {
            copyBtn.innerHTML = checkSvg;
            setTimeout(function () { copyBtn.innerHTML = clipboardSvg; }, 1500);
          });
        });
        div.appendChild(copyBtn);

        var dots = document.createElement('div');
        dots.className = 'thinking-dots';
        dots.innerHTML = '<span></span><span></span><span></span>';
        div.appendChild(dots);

        messagesInner.appendChild(div);
        return div;
      }

      function extractReply(parsed) {
        // Edge Function wraps in {reply: "..."}
        if (parsed.reply) return parsed.reply;
        // Raw Anthropic response: {content: [{type:"text", text:"..."}]}
        if (parsed.content && Array.isArray(parsed.content) && parsed.content.length > 0) {
          var textBlock = parsed.content.find(function (b) { return b.type === 'text'; });
          if (textBlock && textBlock.text) return textBlock.text;
          if (parsed.content[0] && parsed.content[0].text) return parsed.content[0].text;
        }
        // Error from server
        if (parsed.error) return 'Error: ' + (typeof parsed.error === 'string' ? parsed.error : JSON.stringify(parsed.error));
        // Unknown shape
        return 'Unexpected response. Keys: ' + Object.keys(parsed).join(', ');
      }

      function showReply(bubble, text) {
        var dots = bubble.querySelector('.thinking-dots');
        if (dots) dots.remove();
        var span = document.createElement('span');
        span.className = 'msg-text';
        span.textContent = text;
        bubble.appendChild(span);
        var copyBtn = bubble.querySelector('.msg-copy-btn');
        if (copyBtn) copyBtn.style.display = '';
        messageCount++;
        bubble.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }

      var rewriteInstructions = {
        landing_page: 'Rewrite as landing page copy: headline, subheadline, key benefit sections with CTAs.',
        social_post: 'Rewrite as a social media post: concise, with a hook, max 280 characters for the main text.',
        blog_post: 'Rewrite as a blog post: engaging intro, structured sections, conclusion.',
        presentation_slides: 'Rewrite as presentation slide content: one clear headline per slide, 2-3 supporting bullet points per slide, speaker notes for each slide. Aim for 5-8 slides.',
        email_campaign: 'Rewrite as an email campaign: subject line, preview text, email body with clear CTA. Include 3 variants — welcome, nurture, and win-back.',
        job_posting: 'Rewrite as a job posting: role title, punchy intro about the role, key responsibilities, requirements, and a compelling closing CTA to apply.',
        press_release: 'Rewrite as a press release: headline, dateline, lead paragraph with who/what/when/where/why, supporting quotes, boilerplate.',
        ad_copy: 'Rewrite as ad copy variants: 3 Google Ads (30-char headlines + 90-char descriptions) and 3 Meta Ads (short primary text + headline + CTA).',
        video_script: 'Rewrite as a video script: hook (first 3 seconds), problem, solution, proof points, CTA. Include visual direction notes. Aim for 60-90 seconds.',
        changelog: 'Rewrite as a changelog/release notes entry: version header, concise bullet points grouped by New/Improved/Fixed, written in a human tone.'
      };

      var outputInstructions = {
        plain_text: 'Return as plain text, no markup.',
        claude_code_prompt: 'Return as a detailed prompt for Claude Code that will implement this content — include file structure, copy, and styling notes.',
        markdown: 'Return as clean Markdown with proper heading hierarchy, lists, and formatting.'
      };

      function generate() {
        var data = dataInput.value.trim();
        if (!data) return;
        if (!ddState.rewrite) {
          alert('Please select a Rewrite format.');
          return;
        }
        if (!ddState.output) {
          alert('Please select an Output format.');
          return;
        }

        generateBtn.disabled = true;
        messagesArea.style.display = '';
        messagesInner.innerHTML = '';
        chatEl.classList.add('has-response');

        var thinkingBubble = addThinking();

        var rewriteText = rewriteInstructions[ddState.rewrite] || ddState.rewrite;
        var outputText = outputInstructions[ddState.output] || ddState.output;
        var combinedMessage = rewriteText + '\n' + outputText + '\n\nSource content:\n' + data;

        console.log('[TOV] Dropdown state:', JSON.stringify(ddState));
        console.log('[TOV] Combined message:', combinedMessage);
        var reqBody = JSON.stringify({ message: combinedMessage });
        console.log('[TOV] Sending payload:', reqBody);

        fetch('https://ilspxdahkbeayhntskab.supabase.co/functions/v1/bso-tovbot', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsc3B4ZGFoa2JlYXlobnRza2FiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDEyOTUsImV4cCI6MjA4NzE3NzI5NX0.UikA9Zuvoc9sv8yBGvGynBGD9g7TqIgzBb1mpIfgYZU',
            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imlsc3B4ZGFoa2JlYXlobnRza2FiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDEyOTUsImV4cCI6MjA4NzE3NzI5NX0.UikA9Zuvoc9sv8yBGvGynBGD9g7TqIgzBb1mpIfgYZU'
          },
          body: reqBody
        })
        .then(function (res) {
          console.log('[TOV] Response status:', res.status);
          return res.text();
        })
        .then(function (rawText) {
          console.log('[TOV] Raw response:', rawText);
          var parsed;
          try { parsed = JSON.parse(rawText); } catch (e) {
            console.error('[TOV] JSON parse error:', e);
            showReply(thinkingBubble, 'Invalid response from server.');
            generateBtn.disabled = false;
            return;
          }
          console.log('[TOV] Parsed JSON:', JSON.stringify(parsed));
          showReply(thinkingBubble, extractReply(parsed));
          generateBtn.disabled = false;
        })
        .catch(function (err) {
          console.error('[TOV] Fetch error:', err);
          showReply(thinkingBubble, 'Something went wrong. Try again.');
          generateBtn.disabled = false;
        });
      }

      generateBtn.addEventListener('click', generate);
    })();
  </script>
</body>
</html>
